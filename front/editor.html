<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Transport + Carte</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    body { font-family: Arial; }
    #map { height: 420px; margin-bottom: 20px; }
    h2 { margin-top: 30px }
    input, select, button { padding: 6px; margin: 3px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align:left; }
</style>
</head>
<body>

<h1>Ã‰diteur Transport + ArrÃªts</h1>

<!-- ---------------- CATEGORIES ---------------- -->
<h2>CatÃ©gories</h2>
<input id="catName" placeholder="Nom catÃ©gorie">
<button onclick="createCategory()">CrÃ©er</button>

<table>
<thead><tr><th>Nom</th><th>Actions</th></tr></thead>
<tbody id="catTable"></tbody>
</table>

<!-- ---------------- LIGNES ---------------- -->
<h2>Lignes</h2>
<select id="catSelect" onchange="loadLines()"></select>
<br>
<input id="lineName" placeholder="Nom ligne">
<input id="startTime" type="time" value="05:00">
<input id="endTime" type="time" value="23:00">
<button onclick="createLine()">CrÃ©er ligne</button>

<table>
<thead><tr><th>Nom</th><th>DÃ©but</th><th>Fin</th><th>Actions</th></tr></thead>
<tbody id="lineTable"></tbody>
</table>

<!-- ---------------- CARTE + ARRETS ---------------- -->
<h2>ArrÃªts sur Carte</h2>
<select id="lineSelect" onchange="loadStops()"></select>
<div id="map"></div>
<table>
<thead><tr><th>#</th><th>Nom</th><th>Lat</th><th>Lng</th><th>Actions</th></tr></thead>
<tbody id="stopTable"></tbody>
</table>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API = "/api";

// ğŸ’  CARTE
const map = L.map('map').setView([48.8566, 2.3522], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let selectedLatLng = null;

// Mark stops on map
let markers = [];
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[] }

map.on('click', async e => {
    selectedLatLng = e.latlng;
    const name = prompt("Nom de l'arrÃªt ?");
    if (!name) return;
    const lineId = document.getElementById("lineSelect").value;

    const stops = await fetch(`${API}/line/${lineId}/stops`).then(r=>r.json());
    const nextOrder = stops.length + 1;

    await fetch(`${API}/creat/stop`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            name,
            latitude: selectedLatLng.lat,
            longitude: selectedLatLng.lng,
            line_id: parseInt(lineId),
            stop_order: nextOrder
        })
    });

    loadStops();
});

// ----------------- CATEGORIES CRUD -----------------
async function loadCategories(){
    const data = await fetch(`${API}/allcategory`).then(r=>r.json());
    const sel = document.getElementById("catSelect");
    sel.innerHTML="";
    data.forEach(c=>{
        sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`;
    });

    const tbl = document.getElementById("catTable");
    tbl.innerHTML="";
    data.forEach(c=>{
        tbl.innerHTML+=`
        <tr>
            <td>${c.name}</td>
            <td>
                <button onclick="deleteCategory(${c.id})">ğŸ—‘ï¸</button>
            </td>
        </tr>`;
    });

    loadLines();
}
async function createCategory(){
    const name = catName.value;
    await fetch(`${API}/creat/category`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name })
    });
    catName.value="";
    loadCategories();
}
async function deleteCategory(id){
    await fetch(`${API}/delete/category/${id}`,{ method:"DELETE"});
    loadCategories();
}

// ----------------- LIGNES CRUD -----------------
async function loadLines(){
    const catId = catSelect.value;
    const data = await fetch(`${API}/category/${catId}/lines`).then(r=>r.json());

    const tbl = lineTable;
    tbl.innerHTML="";
    data.forEach(l=>{
        tbl.innerHTML+=`
        <tr>
            <td>${l.name}</td>
            <td>${l.start_time}</td>
            <td>${l.end_time}</td>
            <td>
                <button onclick="selectLine(${l.id})">ğŸ“</button>
                <button onclick="deleteLine(${l.id})">ğŸ—‘ï¸</button>
            </td>
        </tr>`;
    });
}
async function createLine(){
    const payload = {
        name: lineName.value,
        category_id: parseInt(catSelect.value),
        start_time: startTime.value,
        end_time: endTime.value
    };
    await fetch(`${API}/creat/line`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
    });
    lineName.value="";
    loadLines();
}
async function deleteLine(id){
    await fetch(`${API}/delete/line/${id}`,{ method:"DELETE" });
    loadLines();
}

// SÃ©lectionner une ligne pour afficher arrÃªts
async function selectLine(id){
    document.getElementById("lineSelect").value = id;
    loadStops();
}

// ----------------- ARRETS CRUD -----------------
async function loadStops(){
    const lineId = lineSelect.value;
    if(!lineId) return;

    const data = await fetch(`${API}/line/${lineId}/stops`).then(r=>r.json());

    const tbl = stopTable;
    tbl.innerHTML="";
    clearMarkers();

    data.forEach(s=>{
        const m = L.marker([s.latitude, s.longitude]).addTo(map).bindPopup(s.name);
        markers.push(m);

        tbl.innerHTML+=`
        <tr>
            <td>${s.stop_order}</td>
            <td>${s.name}</td>
            <td>${s.latitude.toFixed(4)}</td>
            <td>${s.longitude.toFixed(4)}</td>
            <td><button onclick="deleteStop(${s.id})">ğŸ—‘ï¸</button></td>
        </tr>`;
    });
}
async function deleteStop(id){
    const lineId = lineSelect.value;
    await fetch(`${API}/line/${lineId}/remove_stop/${id}`, { method:"DELETE" });
    loadStops();
}

// Init
loadCategories();
</script>
</body>
</html>
